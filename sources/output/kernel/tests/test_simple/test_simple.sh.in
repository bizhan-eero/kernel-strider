#!/bin/sh

trace_sender_module="@trace_sender_module_dir@/@trace_sender_module_name@.ko"

event_collector_module="@event_collector_module_dir@/@event_collector_module_name@.ko"
core_stub_module="@core_stub_module_dir@/@core_stub_module_name@.ko"

test_module="@CMAKE_CURRENT_BINARY_DIR@/@KMODULE_NAME@.ko"

# Initialize
if ! /sbin/insmod "$core_stub_module"; then
    printf "Cannot load core stub module.\n"
    exit 1
fi

if ! /sbin/insmod "$event_collector_module"; then
    printf "Cannot load event collector module.\n"
    /sbin/rmmod "$core_stub_module"
    exit 1
fi

if ! /sbin/insmod "$trace_sender_module" client_addr="127.0.0.1:5678"; then
    printf "Cannot load trace sender module.\n"
    /sbin/rmmod "$event_collector_module"
    /sbin/rmmod "$core_stub_module"
fi

# Test
if ! /sbin/insmod "$test_module"; then
    printf "Cannot load test module or error occures during test.\n"
    /sbin/rmmod "$trace_sender_module"
    /sbin/rmmod "$event_collector_module"
    /sbin/rmmod "$core_stub_module"
    exit 1
fi

if ! /sbin/rmmod "$test_module"; then
    printf "Cannot unload test module.\n"
    exit 1
fi

# Finalize
if ! /sbin/rmmod "$trace_sender_module"; then
    printf "Cannot unload trace sender module.\n"
    exit 1
fi


if ! /sbin/rmmod "$event_collector_module"; then
    printf "Cannot unload event collector module.\n"
    exit 1
fi

if ! /sbin/rmmod "$core_stub_module"; then
    printf "Cannot unload core stub module.\n"
    exit 1
fi
